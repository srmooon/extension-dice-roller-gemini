<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Dado Sortudo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #357ae8;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            color: #34a853;
            font-weight: bold;
        }
        .fail {
            color: #ea4335;
            font-weight: bold;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-box {
            background: #e8f0fe;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üçÄ Teste de Dado Sortudo</h1>
    
    <div class="test-container">
        <h2>Teste R√°pido</h2>
        <p>Clique nos bot√µes para testar se o dado sortudo est√° funcionando corretamente:</p>
        <button onclick="testSingleRoll('1d10')">Testar 1d10</button>
        <button onclick="testSingleRoll('1d20')">Testar 1d20</button>
        <button onclick="testSingleRoll('2d10')">Testar 2d10</button>
        <button onclick="testSingleRoll('3d6')">Testar 3d6</button>
        <div id="quick-results" class="results"></div>
    </div>

    <div class="test-container">
        <h2>Teste de Distribui√ß√£o (100 rolagens)</h2>
        <p>Verifica se TODOS os resultados est√£o nos 70% superiores:</p>
        <button onclick="testDistribution('1d10', 100)">100x 1d10</button>
        <button onclick="testDistribution('1d20', 100)">100x 1d20</button>
        <button onclick="testDistribution('2d6', 100)">100x 2d6</button>
        <div id="distribution-results" class="results"></div>
    </div>

    <div class="test-container">
        <h2>Teste com Vantagem/Desvantagem</h2>
        <p>Verifica se o dado sortudo funciona com vantagem e desvantagem:</p>
        <button onclick="testAdvantage('1d20', 20)">20x 1d20 Vantagem</button>
        <button onclick="testDisadvantage('1d20', 20)">20x 1d20 Desvantagem</button>
        <button onclick="testAdvantage('1d10', 20)">20x 1d10 Vantagem</button>
        <button onclick="testDisadvantage('1d10', 20)">20x 1d10 Desvantagem</button>
        <div id="advantage-results" class="results"></div>
    </div>

    <script src="../utils/random-generator.js"></script>
    <script src="../utils/dice-parser.js"></script>
    <script src="../utils/roll-engine.js"></script>

    <script>
        const rollEngine = new RollEngine();

        function testSingleRoll(diceFormat) {
            const resultsDiv = document.getElementById('quick-results');
            const parsed = rollEngine.parser.parse(diceFormat);
            
            if (!parsed) {
                resultsDiv.innerHTML = '<span class="fail">‚ùå Formato inv√°lido!</span>';
                return;
            }

            // Rola COM dado sortudo
            const luckyResult = rollEngine.roll(diceFormat, 'normal', true);
            
            // Calcula o m√≠nimo esperado (70% superior)
            const minExpected = Math.ceil(parsed.sides * 0.7);
            
            // Verifica se TODOS os dados ca√≠ram na faixa esperada
            const allGood = luckyResult.selectedRolls.every(roll => roll >= minExpected);
            
            let html = `<h3>Resultado: ${diceFormat} com Dado Sortudo üçÄ</h3>`;
            html += `<p><strong>Resultado Final:</strong> ${luckyResult.finalResult}</p>`;
            html += `<p><strong>Dados Individuais:</strong> [${luckyResult.selectedRolls.join(', ')}]</p>`;
            html += `<p><strong>Faixa Esperada:</strong> ${minExpected}-${parsed.sides} (70% superior)</p>`;
            
            if (allGood) {
                html += `<p class="success">‚úÖ SUCESSO! Todos os dados ca√≠ram na faixa esperada!</p>`;
            } else {
                html += `<p class="fail">‚ùå FALHA! Algum dado caiu fora da faixa esperada!</p>`;
            }
            
            resultsDiv.innerHTML = html;
        }

        function testDistribution(diceFormat, rolls) {
            const resultsDiv = document.getElementById('distribution-results');
            const parsed = rollEngine.parser.parse(diceFormat);
            
            if (!parsed) {
                resultsDiv.innerHTML = '<span class="fail">‚ùå Formato inv√°lido!</span>';
                return;
            }

            resultsDiv.innerHTML = '<p>Testando... aguarde...</p>';

            setTimeout(() => {
                const minExpected = Math.ceil(parsed.sides * 0.7);
                let successCount = 0;
                let failCount = 0;
                const allResults = [];
                const distribution = {};

                // Inicializa distribui√ß√£o
                for (let i = 1; i <= parsed.sides; i++) {
                    distribution[i] = 0;
                }

                // Faz as rolagens
                for (let i = 0; i < rolls; i++) {
                    const result = rollEngine.roll(diceFormat, 'normal', true);
                    allResults.push(result.selectedRolls);
                    
                    // Verifica se todos os dados est√£o na faixa
                    const allGood = result.selectedRolls.every(roll => roll >= minExpected);
                    if (allGood) {
                        successCount++;
                    } else {
                        failCount++;
                    }

                    // Conta distribui√ß√£o (apenas para dados √∫nicos)
                    if (parsed.count === 1) {
                        distribution[result.selectedRolls[0]]++;
                    }
                }

                // Calcula estat√≠sticas
                const successRate = (successCount / rolls * 100).toFixed(1);
                
                let html = `<h3>Teste de ${rolls} rolagens: ${diceFormat} üçÄ</h3>`;
                html += `<div class="stats">`;
                html += `<div class="stat-box"><strong>Sucessos:</strong> ${successCount}/${rolls}</div>`;
                html += `<div class="stat-box"><strong>Falhas:</strong> ${failCount}/${rolls}</div>`;
                html += `<div class="stat-box"><strong>Taxa de Sucesso:</strong> ${successRate}%</div>`;
                html += `<div class="stat-box"><strong>Faixa Esperada:</strong> ${minExpected}-${parsed.sides}</div>`;
                html += `</div>`;

                if (parsed.count === 1) {
                    html += `<h4>Distribui√ß√£o dos Resultados:</h4>`;
                    html += `<div style="font-family: monospace;">`;
                    for (let i = 1; i <= parsed.sides; i++) {
                        const count = distribution[i];
                        const percentage = (count / rolls * 100).toFixed(1);
                        const bar = '‚ñà'.repeat(Math.floor(count / 2));
                        const isInRange = i >= minExpected;
                        const color = isInRange ? '#34a853' : '#ea4335';
                        html += `<div style="color: ${color}">`;
                        html += `${i.toString().padStart(2)}: ${bar} ${count} (${percentage}%)`;
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                if (successRate === '100.0') {
                    html += `<p class="success">‚úÖ PERFEITO! 100% dos resultados na faixa esperada!</p>`;
                } else if (successRate >= '95.0') {
                    html += `<p class="success">‚úÖ MUITO BOM! ${successRate}% na faixa esperada!</p>`;
                } else {
                    html += `<p class="fail">‚ùå PROBLEMA! Apenas ${successRate}% na faixa esperada!</p>`;
                }

                resultsDiv.innerHTML = html;
            }, 100);
        }

        function testAdvantage(diceFormat, rolls) {
            const resultsDiv = document.getElementById('advantage-results');
            const parsed = rollEngine.parser.parse(diceFormat);
            
            if (!parsed) {
                resultsDiv.innerHTML = '<span class="fail">‚ùå Formato inv√°lido!</span>';
                return;
            }

            resultsDiv.innerHTML = '<p>Testando vantagem... aguarde...</p>';

            setTimeout(() => {
                const minExpected = Math.ceil(parsed.sides * 0.7);
                let successCount = 0;
                let failCount = 0;
                const allResults = [];

                // Faz as rolagens com vantagem
                for (let i = 0; i < rolls; i++) {
                    const result = rollEngine.roll(diceFormat, 'advantage', true);
                    allResults.push(result);
                    
                    // Verifica se o resultado final est√° na faixa
                    const finalInRange = result.selectedRolls.every(roll => roll >= minExpected);
                    
                    // Verifica se TODOS os dados rolados (incluindo os descartados) est√£o na faixa
                    let allDiceInRange = true;
                    if (result.rolls && Array.isArray(result.rolls[0])) {
                        // Vantagem/Desvantagem - verifica todos os pares
                        result.rolls.forEach(pair => {
                            pair.forEach(die => {
                                if (die < minExpected) allDiceInRange = false;
                            });
                        });
                    }
                    
                    if (finalInRange && allDiceInRange) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                }

                const successRate = (successCount / rolls * 100).toFixed(1);
                
                let html = `<h3>Teste de ${rolls} rolagens: ${diceFormat} com VANTAGEM üçÄ</h3>`;
                html += `<div class="stats">`;
                html += `<div class="stat-box"><strong>Sucessos:</strong> ${successCount}/${rolls}</div>`;
                html += `<div class="stat-box"><strong>Falhas:</strong> ${failCount}/${rolls}</div>`;
                html += `<div class="stat-box"><strong>Taxa de Sucesso:</strong> ${successRate}%</div>`;
                html += `<div class="stat-box"><strong>Faixa Esperada:</strong> ${minExpected}-${parsed.sides}</div>`;
                html += `</div>`;

                // Mostra alguns exemplos
                html += `<h4>Exemplos de Rolagens:</h4>`;
                html += `<div style="font-family: monospace;">`;
                for (let i = 0; i < Math.min(5, allResults.length); i++) {
                    const r = allResults[i];
                    if (r.rolls && Array.isArray(r.rolls[0])) {
                        const pairs = r.rolls.map(p => `(${p[0]}, ${p[1]})`).join(', ');
                        html += `<div>Rolagem ${i+1}: ${pairs} ‚Üí Escolhido: [${r.selectedRolls.join(', ')}] = ${r.finalResult}</div>`;
                    }
                }
                html += `</div>`;

                if (successRate === '100.0') {
                    html += `<p class="success">‚úÖ PERFEITO! Todos os dados (incluindo os descartados) est√£o na faixa esperada!</p>`;
                    html += `<p class="success">Isso significa que com Vantagem + Dado Sortudo, voc√™ SEMPRE tem dois resultados altos para escolher!</p>`;
                } else {
                    html += `<p class="fail">‚ùå PROBLEMA! Alguns dados ca√≠ram fora da faixa!</p>`;
                }

                resultsDiv.innerHTML = html;
            }, 100);
        }

        function testDisadvantage(diceFormat, rolls) {
            const resultsDiv = document.getElementById('advantage-results');
            const parsed = rollEngine.parser.parse(diceFormat);
            
            if (!parsed) {
                resultsDiv.innerHTML = '<span class="fail">‚ùå Formato inv√°lido!</span>';
                return;
            }

            resultsDiv.innerHTML = '<p>Testando desvantagem... aguarde...</p>';

            setTimeout(() => {
                const minExpected = Math.ceil(parsed.sides * 0.7);
                let successCount = 0;
                let failCount = 0;
                const allResults = [];

                // Faz as rolagens com desvantagem
                for (let i = 0; i < rolls; i++) {
                    const result = rollEngine.roll(diceFormat, 'disadvantage', true);
                    allResults.push(result);
                    
                    // Verifica se o resultado final est√° na faixa
                    const finalInRange = result.selectedRolls.every(roll => roll >= minExpected);
                    
                    // Verifica se TODOS os dados rolados (incluindo os descartados) est√£o na faixa
                    let allDiceInRange = true;
                    if (result.rolls && Array.isArray(result.rolls[0])) {
                        // Vantagem/Desvantagem - verifica todos os pares
                        result.rolls.forEach(pair => {
                            pair.forEach(die => {
                                if (die < minExpected) allDiceInRange = false;
                            });
                        });
                    }
                    
                    if (finalInRange && allDiceInRange) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                }

                const successRate = (successCount / rolls * 100).toFixed(1);
                
                let html = `<h3>Teste de ${rolls} rolagens: ${diceFormat} com DESVANTAGEM üçÄ</h3>`;
                html += `<div class="stats">`;
                html += `<div class="stat-box"><strong>Sucessos:</strong> ${successCount}/${rolls}</div>`;
                html += `<div class="stat-box"><strong>Falhas:</strong> ${failCount}/${rolls}</div>`;
                html += `<div class="stat-box"><strong>Taxa de Sucesso:</strong> ${successRate}%</div>`;
                html += `<div class="stat-box"><strong>Faixa Esperada:</strong> ${minExpected}-${parsed.sides}</div>`;
                html += `</div>`;

                // Mostra alguns exemplos
                html += `<h4>Exemplos de Rolagens:</h4>`;
                html += `<div style="font-family: monospace;">`;
                for (let i = 0; i < Math.min(5, allResults.length); i++) {
                    const r = allResults[i];
                    if (r.rolls && Array.isArray(r.rolls[0])) {
                        const pairs = r.rolls.map(p => `(${p[0]}, ${p[1]})`).join(', ');
                        html += `<div>Rolagem ${i+1}: ${pairs} ‚Üí Escolhido: [${r.selectedRolls.join(', ')}] = ${r.finalResult}</div>`;
                    }
                }
                html += `</div>`;

                if (successRate === '100.0') {
                    html += `<p class="success">‚úÖ INCR√çVEL! Mesmo com DESVANTAGEM, todos os resultados est√£o na faixa alta!</p>`;
                    html += `<p class="success">Com Dado Sortudo, at√© a desvantagem te d√° resultados bons! üòÑ</p>`;
                } else {
                    html += `<p class="fail">‚ùå PROBLEMA! Alguns dados ca√≠ram fora da faixa!</p>`;
                }

                resultsDiv.innerHTML = html;
            }, 100);
        }

        // Teste autom√°tico ao carregar
        window.addEventListener('load', () => {
            console.log('üçÄ P√°gina de teste carregada!');
            console.log('Clique nos bot√µes para testar o dado sortudo.');
        });
    </script>
</body>
</html>
